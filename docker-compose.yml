# =============================================================================
# Docker Compose - Outil Emailing (Architecture MVVM Feature-First)
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # Service principal de l'application (Production)
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: outil-emailing-app
    image: outil-emailing:latest
    env_file:
      - .env
    ports:
      - "${APP_PORT:-5000}:5000"
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - FLASK_DEBUG=${FLASK_DEBUG:-0}
      - APP_SECRET_KEY=${APP_SECRET_KEY}
      - SECRET_KEY=${SECRET_KEY}
      # Configuration SMTP
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}
      - SMTP_USE_SSL=${SMTP_USE_SSL:-false}
      - SMTP_SENDER_NAME=${SMTP_SENDER_NAME}
      - SMTP_REPLY_TO=${SMTP_REPLY_TO}
      # Configuration Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      # Configuration Unsubscribe
      - UNSUBSCRIBE_BASE_URL=${UNSUBSCRIBE_BASE_URL:-http://localhost:5000}
      # Configuration logs
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      # Volume pour les données persistantes (uploads, logs, exports)
      - app-data:/app/data
      # Templates montés en lecture seule
      - ./templates:/app/templates:ro
    restart: unless-stopped
    networks:
      - emailing-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Service de développement (avec hot-reload)
  # ---------------------------------------------------------------------------
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: outil-emailing-dev
    ports:
      - "${DEV_BACKEND_PORT:-5001}:5000"
      - "${DEV_FRONTEND_PORT:-3000}:3000"
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - VITE_API_URL=http://localhost:5001/api
      # Configuration SMTP pour les tests
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    volumes:
      # Montage du code source pour hot-reload
      # Structure MVVM Feature-First
      - ./app:/app/app
      - ./templates:/app/templates
      - ./examples:/app/examples
      # Exclure node_modules du montage
      - /app/node_modules
      # Volume pour les données de développement
      - dev-data:/app/data
    restart: unless-stopped
    networks:
      - emailing-network
    profiles:
      - dev

# -----------------------------------------------------------------------------
# Réseaux
# -----------------------------------------------------------------------------
networks:
  emailing-network:
    driver: bridge
    name: outil-emailing-network

# -----------------------------------------------------------------------------
# Volumes persistants
# -----------------------------------------------------------------------------
volumes:
  app-data:
    driver: local
    name: outil-emailing-data
  dev-data:
    driver: local
    name: outil-emailing-dev-data
