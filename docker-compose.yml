# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  email_network:
    driver: bridge

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  redis_data:
    driver: local

# ==============================================================================
# SERVICES
# ==============================================================================
services:
  # ============================================================================
  # REDIS - Cache & Message Broker
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: email-campaign-redis
    profiles: ["full", "production"]
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - email_network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # BACKEND API
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: email-campaign-backend
    env_file:
      - ./.env
    environment:
      # Core
      - APP_NAME=${APP_NAME:-Email Campaign Platform}
      - APP_ENV=${APP_ENV:-production}
      - DEBUG=${DEBUG:-false}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost,http://localhost:5173,http://localhost:3000}
      
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      
      # Email Provider (SMTP only)
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-smtp}
      
      # Redis & Celery (when available)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - CELERY_BROKER_URL=${CELERY_BROKER_URL:-redis://redis:6379/0}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND:-redis://redis:6379/1}
      
      # Rate Limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE:-100}
      
      # Observability
      - ENABLE_METRICS=${ENABLE_METRICS:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--proxy-headers"]
    ports:
      - "8000:8000"
    networks:
      - email_network
    volumes:
      - ./backend:/app:ro
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,nodev
      - /run:rw,noexec,nosuid,nodev
    user: "1000:1000"
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "1.0"
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ============================================================================
  # CELERY WORKER
  # ============================================================================
  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: email-campaign-celery-worker
    profiles: ["full", "production"]
    env_file:
      - ./.env
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-smtp}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    command: celery -A core.celery_tasks worker --loglevel=info --concurrency=4
    depends_on:
      - redis
      - backend
    volumes:
      - ./backend:/app:ro
    networks:
      - email_network
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M
    restart: unless-stopped

  # ============================================================================
  # CELERY BEAT SCHEDULER
  # ============================================================================
  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: email-campaign-celery-beat
    profiles: ["full", "production"]
    env_file:
      - ./.env
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    command: celery -A core.celery_tasks beat --loglevel=info
    depends_on:
      - redis
      - backend
    volumes:
      - ./backend:/app:ro
    networks:
      - email_network
    restart: unless-stopped

  # ============================================================================
  # FLOWER - Celery Monitoring
  # ============================================================================
  flower:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: email-campaign-flower
    profiles: ["full", "monitoring"]
    env_file:
      - ./.env
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/1
    command: celery -A core.celery_tasks flower --port=5555
    ports:
      - "5555:5555"
    depends_on:
      - redis
      - celery_worker
    networks:
      - email_network
    restart: unless-stopped

  # ============================================================================
  # FRONTEND
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
    container_name: email-campaign-frontend
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - email_network
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,nodev,mode=1777
      - /run:rw,noexec,nosuid,nodev,mode=1777
      - /var/cache/nginx:rw,noexec,nosuid,nodev,uid=101,gid=101,mode=0755
      - /var/run:rw,noexec,nosuid,nodev,uid=101,gid=101,mode=0755
    user: "101:101"
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
